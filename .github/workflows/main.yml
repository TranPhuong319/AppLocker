name: Build

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      critical:
        description: "Mark this release as a critical update (Sparkle)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  Build:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: build/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install Dependencies
        run: |
          brew install create-dmg swiftlint xcbeautify
          python -m pip install --upgrade pip
          python -m pip install pycountry
        env:
          HOMEBREW_NO_INSTALL_CLEANUP: 1
          HOMEBREW_NO_AUTO_UPDATE: 1

      - name: Manage Version
        if: (github.event_name == 'push' && (github.ref_name == 'main' || startsWith(github.ref_name, 'release/'))) || github.event_name == 'workflow_dispatch'
        run: |
          git fetch --prune --tags
          CUR_TAG="$(git tag -l | grep -i 'alpha' | tail -1)"
          MARKETING_VERSION=$(grep "MARKETING_VERSION" AppLocker.xcodeproj/project.pbxproj \
            | grep -v '\$' \
            | head -n 1 \
            | sed -E 's/.*= *"?([^";]+)"?;.*/\1/')

          if [[ "$GITHUB_EVENT_NAME" != 'workflow_dispatch' ]]; then
            # alpha
            sed -i '' -e "s/CURRENT_PROJECT_VERSION =.*/CURRENT_PROJECT_VERSION = \"${GITHUB_RUN_NUMBER}\";/g" AppLocker.xcodeproj/project.pbxproj
          else
            # stable
            sed -i '' -e "s/CURRENT_PROJECT_VERSION =.*/CURRENT_PROJECT_VERSION = \"${GITHUB_RUN_NUMBER}\";/g" AppLocker.xcodeproj/project.pbxproj
          fi
          echo "VER=$MARKETING_VERSION" >> $GITHUB_ENV
          if [[ -z $CUR_TAG ]]; then
            echo "OLD_PRE_TAG=NULL" >> $GITHUB_ENV
          else
            echo "OLD_PRE_TAG=$CUR_TAG">> $GITHUB_ENV
          fi
        shell: zsh {0}

      - name: Lint Code
        run: |
          swiftlint lint --reporter github-actions-logging
        continue-on-error: true
      - name: i18n Stats
        run: python .github/scripts/check_localization.py

      - name: Release Archive
        run: |
          set -o pipefail && xcodebuild archive \
            -scheme AppLocker \
            -configuration Release \
            -archivePath build/AppLocker.xcarchive \
            -derivedDataPath build \
            -disableAutomaticPackageResolution \
            CODE_SIGN_IDENTITY="-" CODE_SIGNING_REQUIRED=NO \
            | xcbeautify --renderer terminal

      - name: Create Disk Image
        if: (github.event_name == 'push' && (github.ref_name == 'main' || startsWith(github.ref_name, 'release/'))) || github.event_name == 'workflow_dispatch'
        run: |
          XCBUILD_PATH="build/AppLocker.xcarchive/Products/Applications"
          cp LICENSE $XCBUILD_PATH
          cd $XCBUILD_PATH
          curl -sLO https://openintelwireless.github.io/HeliPort/dmg/dmg-background.tiff
          create-dmg \
            --volname "AppLocker" \
            --background "dmg-background.tiff" \
            --window-pos 200 120 \
            --window-size 660 420 \
            --text-size 12 \
            --eula "LICENSE" \
            --icon-size 160 \
            --icon "AppLocker.app" 180 170 \
            --hide-extension "AppLocker.app" \
            --app-drop-link 480 170 \
            "AppLocker.dmg" \
            "./AppLocker.app"
          cd -
          mkdir Artifacts
          cp -R ${XCBUILD_PATH}/*.dmg Artifacts

      - name: Setup Prerelease Variables
        if: github.event_name == 'push' && (github.ref_name == 'main' || startsWith(github.ref_name, 'release/'))
        run: |
          echo "REL_TAG=v${VER}-alpha" >> $GITHUB_ENV
          echo "IS_PRE=true" >> $GITHUB_ENV
          echo '### Disclaimer:' >> ReleaseNotes.md
          echo '***This alpha version is for testing only.***' >> ReleaseNotes.md
          echo 'It is not ready for daily use and we do not guarantee its usability.' >> ReleaseNotes.md

      - name: Setup Release Variables
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "REL_TAG=v${VER}" >> $GITHUB_ENV
          echo "IS_PRE=false" >> $GITHUB_ENV

      - name: Generate Changelog
        id: changelog
        if: (github.event_name == 'push' && (github.ref_name == 'main' || startsWith(github.ref_name, 'release/'))) || github.event_name == 'workflow_dispatch'
        run: |
          python .github/scripts/generate_changelog.py --to-ref HEAD

      - name: Delete Old Prerelease
        if: (github.event_name == 'push' && (github.ref_name == 'main' || startsWith(github.ref_name, 'release/')) && steps.changelog.outputs.HAS_CHANGES == 'true') || github.event_name == 'workflow_dispatch'
        run: gh release delete ${{ env.OLD_PRE_TAG }} --cleanup-tag
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Sparkle Key
        run: |
          echo "${SPARKLE_KEY}" | tr -d '\r' > sparkle_key.pem
          chmod 600 sparkle_key.pem
        env:
          SPARKLE_KEY: ${{ secrets.SPARKLE_KEY }}

      - name: Setup Critical Update Flag
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [[ "${{ inputs.critical }}" == "true" ]]; then
            echo "SPARKLE_CRITICAL=true" >> $GITHUB_ENV
          else
            echo "SPARKLE_CRITICAL=false" >> $GITHUB_ENV
          fi
          if [[ "$GITHUB_EVENT_NAME" != "workflow_dispatch" ]]; then
            SPARKLE_CRITICAL=false
          fi

      - name: Default Critical Flag (push)
        if: github.event_name == 'push'
        run: echo "SPARKLE_CRITICAL=false" >> $GITHUB_ENV

      - name: Generate Sparkle Appcast
        if: (github.event_name == 'push' && (github.ref_name == 'main' || startsWith(github.ref_name, 'release/'))) || github.event_name == 'workflow_dispatch'
        run: |
          SHORTSTRING="${VER}"
          if [[ "$GITHUB_EVENT_NAME" == "push" ]]; then
            # push → pre-release alpha
            DMG_URL="https://github.com/TranPhuong319/AppLocker/releases/download/${REL_TAG}/AppLocker.dmg"
          else
            # workflow_dispatch → stable
            DMG_URL="https://github.com/TranPhuong319/AppLocker/releases/latest/download/AppLocker.dmg"
          fi

          APPCAST_VER="${GITHUB_RUN_NUMBER}"
          CUR_VER="${APPCAST_VER}"
          sed -i '' -e "s/CURRENT_PROJECT_VERSION =.*/CURRENT_PROJECT_VERSION = \"${CUR_VER}\";/g" AppLocker.xcodeproj/project.pbxproj

          CHANGELOG="$(cat changelog_body.html)"
          PUBDATE="$(date +"%a, %d %b %Y %T %z")"
          SPARKLE_BIN='./build/SourcePackages/artifacts/sparkle/Sparkle/bin'
          SIGNED_ATTR=$($SPARKLE_BIN/sign_update --ed-key-file sparkle_key.pem ./Artifacts/AppLocker.dmg)
          CRITICAL_ATTR=""
          if [[ "$SPARKLE_CRITICAL" == "true" ]]; then
            CRITICAL_ATTR="<sparkle:criticalUpdate />"
          fi
          CHANNEL_ATTR=""
          if [[ "$GITHUB_EVENT_NAME" == "push" ]]; then
            CHANNEL_ATTR='sparkle:channel="beta"'
          fi

          APPCAST=(
              '<?xml version="1.0" standalone="yes"?>'
              '<rss xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" version="2.0">'
              '    <channel>'
              '        <title>AppLocker</title>'
              '        <item>'
              "            <title>${VER}</title>"
              "            <pubDate>${PUBDATE}</pubDate>"
              '            ${CRITICAL_ATTR}
              '            <description><![CDATA['
              '                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/19.4.0/primer.min.css">'
              '                <meta charset="UTF-8">'
              '                <style>'
              '                @media (prefers-color-scheme: dark) {'
              '                  body { background:#0d1117; color:#c9d1d9; }'
              '                  a { color:#58a6ff; }'
              '                }'
              '                @media (prefers-color-scheme: light) {'
              '                  body { background:#ffffff; color:#24292f; }'
              '                  a { color:#0969da; }'
              '                }'
              '                </style>'
              '                <div class="markdown-body">'
              '                  <h3>The latest updates are:</h3>'
              '                  <ul>'
              "${CHANGELOG}"
              '                  </ul>'
              '                </div>'
              '            ]]>'
              '            </description>'
              '            <sparkle:minimumSystemVersion>13.5</sparkle:minimumSystemVersion>'
              "            <enclosure url='${DMG_URL}' sparkle:version='${APPCAST_VER}' sparkle:shortVersionString='${SHORTSTRING}' type='application/octet-stream' ${CHANNEL_ATTR} ${SIGNED_ATTR}/>"
              '        </item>'
              '    </channel>'
              '</rss>'
          )
          for appcast in "${APPCAST[@]}"; do
              echo "${appcast}" >> ./Artifacts/appcast.xml
          done
        shell: zsh {0}
        env:
          SPARKLE_KEY: ${{ secrets.SPARKLE_KEY }}

      - name: Publish GitHub Release
        if: ((github.event_name == 'push' && (github.ref_name == 'main' || startsWith(github.ref_name, 'release/')) && steps.changelog.outputs.HAS_CHANGES == 'true') || github.event_name == 'workflow_dispatch') && contains(github.event.head_commit.message, 'Bump version') == false
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          replacesArtifacts: true
          prerelease: ${{ env.IS_PRE }}
          bodyFile: ReleaseNotes.md
          artifacts: "./Artifacts/*"
          tag: ${{ env.REL_TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}
